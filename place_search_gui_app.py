# -*- coding: utf-8 -*-
import sys
import io
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

import streamlit as st
import requests
import pandas as pd
import time
from urllib.parse import quote
from datetime import datetime
import re

# === μ‚¬μ©μ μ„¤μ • ===
KAKAO_API_KEY = '9413618fb8b362446e851b5ddd0e990c'

# === ν•¨μ μ •μ ===
def get_coordinates(place_name):
    query = quote(place_name)
    url = f"https://dapi.kakao.com/v2/local/search/keyword.json?query={query}"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_API_KEY}",
        "Accept-Charset": "utf-8"
    }
    res = requests.get(url, headers=headers)
    if res.status_code != 200:
        st.error(f"[μΆν‘ μ¤λ¥] μ”μ²­ μ‹¤ν¨: {res.status_code}")
        st.text(res.text)
        return None, None
    documents = res.json().get("documents", [])
    if not documents:
        return None, None
    return float(documents[0]['x']), float(documents[0]['y'])

def extract_address_parts(road_address):
    si = gu = dong = road = ""
    match = re.match(r"(μ„μΈ|λ¶€μ‚°|λ€κµ¬|μΈμ²|κ΄‘μ£Ό|λ€μ „|μΈμ‚°|μ„ΈμΆ…|κ²½κΈ°|κ°•μ›|μ¶©λ¶|μ¶©λ‚¨|μ „λ¶|μ „λ‚¨|κ²½λ¶|κ²½λ‚¨|μ μ£Ό)?\s*([\wκ°€-ν£]+κµ¬)?\s*([\wκ°€-ν£]+(λ™|μ|λ©΄|λ¦¬))?\s*([\wκ°€-ν£0-9]+λ΅)?", road_address)
    if match:
        si = match.group(1) if match.group(1) else ""
        gu = match.group(2) if match.group(2) else ""
        dong = match.group(3) if match.group(3) else ""
        road = match.group(5) if match.group(5) else ""
    return si+gu, dong, road

def search_places(x, y, radius, keywords):
    headers = {
        "Authorization": f"KakaoAK {KAKAO_API_KEY}",
        "Accept-Charset": "utf-8"
    }
    all_places = []
    for keyword in keywords:
        query = quote(keyword)
        page = 1
        st.write(f"π” κ²€μƒ‰ μ¤‘: {keyword}")
        while True:
            url = f"https://dapi.kakao.com/v2/local/search/keyword.json?query={query}&x={x}&y={y}&radius={radius}&page={page}&size=15"
            res = requests.get(url, headers=headers)
            if res.status_code != 200:
                st.error(f"[μ”μ²­ μ‹¤ν¨] μƒνƒμ½”λ“ {res.status_code}")
                st.text(res.text)
                break
            data = res.json()
            documents = data.get("documents", [])
            if not documents:
                break
            for item in documents:
                si_gu, dong, road = extract_address_parts(item['road_address_name'])
                all_places.append({
                    'κ²€μƒ‰μ–΄': keyword,
                    'μ‹/κµ¬': si_gu,
                    'λ™/λ©΄/μ/λ¦¬': dong,
                    'λ„λ΅λ…': road,
                    'μ¥μ†λ…': item['place_name'],
                    'μ£Όμ†': item['road_address_name'],
                    'μ„λ„': item['y'],
                    'κ²½λ„': item['x']
                })
            if data['meta'].get('is_end'):
                break
            page += 1
            time.sleep(0.3)
    return all_places

# === Streamlit μΈν„°νμ΄μ¤ ===
st.title("π“ ν‚¤μ›λ“ κΈ°λ° μ¥μ† μμ§‘κΈ° (μΉ΄μΉ΄μ¤ API)")
place_name = st.text_input("μ¥μ†λ…μ„ μ…λ ¥ν•μ„Έμ” (μ: κ°•λ‚¨μ—­)", "λΌλ”°λμ΄μΈμ„μΈ")
radius = st.number_input("λ°κ²½ μ„¤μ • (λ―Έν„° λ‹¨μ„)", min_value=100, max_value=20000, value=1000, step=100)

if st.button("κ²€μƒ‰ μ‹μ‘"):
    x, y = get_coordinates(place_name)
    if x is None or y is None:
        st.error("β μ¥μ†λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤. μ •ν™•ν μ…λ ¥ν•΄μ£Όμ„Έμ”.")
    else:
        keywords =  [
    "κ°€", "κ°•", "κ±΄", "κ²½", "κ³„", "κ³ ", "κ³΅", "κ³µ", "κ΄€", "κ΄‘", "κµ", "κµ¬", "κµ­", "κµ°", "κΈ", "κΈ°",
    "κΈΈ", "λ‚", "λ‚™", "λ‚¨", "λ‚΄", "λ…Έ", "λ„", "λ‹¤", "λ‹¨", "λ‹Ή", "λ€", "λ•", "λ„", "λ™", "λ‘", "λ“±",
    "λΌ", "λ΅", "λ¦¬", "λ§", "λ§", "λ…", "λ¨", "λ¬΄", "λ¬Έ", "λ―Έ", "λ―Ό", "λ°•", "λ°", "λ°©", "λ°°", "λ°±",
    "λ²”", "λ²•", "λ³µ", "λ΄‰", "λ¶€", "λ¶", "λ¶„", "λ¶", "μ‚¬", "μ‚°", "μ‚Ό", "μƒ", "μ„", "μ„", "μ„ ", "μ„¤",
    "μ„±", "μ„Έ", "μ†", "μ†΅", "μ", "μ™", "μ", "μ‹", "μ‹ ", "μ‹¬", "μ•„", "μ•", "μ–‘", "μ–΄", "μ—„", "μ—¬",
    "μ—­", "μ—°", "μ—΄", "μ", "μ¤", "μ¨", "μ™€", "μ™•", "μ©", "μ°", "μ΄", "μΈ", "μ›", "μ›”", "μ„", "μ ",
    "μ¤", "μ€", "μ", "μ‘", "μ", "μ΄", "μΈ", "μΌ", "μ„", "μ", "μ¥", "μ „", "μ •", "μ ", "μ΅°", "μ£Ό",
    "μ£½", "μ¤‘", "μ§€", "μ§„", "μ°½", "μ²", "μ² ", "μ²­", "μ΄", "μ¶", "μ¶©", "μΉ", "μΉ", "νƒ€", "νƒ‘", "ν†µ",
    "ν", "ν‰", "ν¬", "ν•", "ν•", "ν•¨", "ν•΄", "ν„", "ν•", "νΈ", "ν™", "ν™”", "ν¨", "ν¥",
    "κ°•λ‹Ή", "κ°•μμ‹¤", "κ±°λ¦¬", "κ²€μ°°μ²­", "κ²μ¤νΈν•μ°μ¤", "κ²°νΌμ‹μ¥", "κ²½μ°°μ„", "κ³„κ³΅", "κ³ κ°μ„Όν„°", "κ³ λ“±λ²•μ›",
    "κ³ λ“±ν•™κµ", "κ³ μ†ν„°λ―Έλ„", "κ³µκ³µμ‹μ„¤", "κ³µλ‹¨", "κ³µμ—°μ¥", "κ³µμ", "κ³µμμ£Όμ°¨μ¥", "κ³µμ›", "κ³µμ¥", "κ³Όν•™κ΄€",
    "κ΄‘μ—­μ‹μ²­", "κ΄‘μ—­ν™μΉ", "κ΄‘μ¥", "κµμ΅μ²­", "κµ¬λ¦½", "κµ¬μ²­", "κµ­κ³µλ¦½", "κµ­λ¦½λ³‘μ›", "κµ­λ―Όμ²΄μ΅μ„Όν„°", "κµ­μ•…λ‹Ή",
    "κµ°μ²­", "κΈ°λ…κ΄€", "κΈ°μ—…μ§€μ›μ„Όν„°", "λ…ΈμΈλ³µμ§€κ΄€", "λ…ΈμΈμ„Όν„°", "λ…ΈμΈμ •", "λ†€μ΄ν„°", "λ‹¤μ„Έλ€", "λ‹¨λ…μ£Όνƒ",
    "λ„μ„κ΄€", "λ„μ²­", "λ™λ¬Όμ›", "λ™μ‚¬λ¬΄μ†", "λ””μ§€ν„Έλ„μ„κ΄€", "λ μ§€λμ¤", "λ¦¬μ΅°νΈ", "λ§μ„νκ΄€", "λ§νΈ", "λ¨ν…”",
    "λ¬Έν™”κ΄€", "λ¬Έν™”μ„Όν„°", "λ¬Έν™”μμ νκ΄€", "λ¬Έν™”μ›", "λ¬Έν™”μμ§‘", "λ¬Έν™”νκ΄€", "λ―Έμ κ΄€", "λ―Όλ°•", "λ°•λν",
    "λ°•λνμ¥", "λ°•λ¬Όκ΄€", "λ°©μ†΅κµ­", "λ°±ν™”μ ", "λ²•μ›μ²­μ‚¬", "λ³„κ΄€", "λ³‘μ›", "λ³΄κ±΄μ†", "λ³΄ν›λ³‘μ›", "λ³µμ§€κ΄€",
    "λ³µν•©λ‹¨μ§€", "λ³µν•©μ„Όν„°", "λ³Έκ΄€", "λ¶„κ΄€", "λ¶„μ†", "λΉλ”©", "λΉλΌ", "μ‚¬νλ³µμ§€κ΄€", "μƒκ°€", "μƒνƒμ›",
    "μƒν™μ²΄μ΅κ΄€", "μ„Όν„°", "μ†λ°©μ„", "μλ©μ›", "μμ΅±κ΄€", "μ‹λ¦½", "μ‹λ―Όνκ΄€", "μ‹μ„¤", "μ‹μν", "μ‹μ¥",
    "μ‹μ²­", "μ‹λ¬Όμ›", "μ‹ λ¬Έμ‚¬", "μ•„νΈμ„Όν„°", "μ•„ννΈ", "μ•½κµ­", "μ–΄λ¦°μ΄μ§‘", "μ—¬κ΄€", "μ—¬μ„±νκ΄€", "μ—¬μΈμ™",
    "μ—­", "μ—­μ‚¬λ°•λ¬Όκ΄€", "μ—°κµ¬μ†", "μ—°λ¦½", "μ—°μμ›", "μμ—…μ†", "μμ μμ „λ‹Ή", "μμ νκ΄€", "μμ‹μ¥", "μ¤ν”Όμ¤ν…”",
    "μ°μ²΄κµ­", "μ΄λ™μ¥", "μ μΉμ›", "μμ•…λ‹Ή", "μμ›", "μ „λ‹Ή", "μ „λ§λ€", "μ „μ‹κ΄€", "μ „μ‹μ„Όν„°", "μ „μ‹μ¥",
    "μ „μ‹ν™€", "μ „ν†µμ‹μ¥", "μ •λ¥μ¥", "μ •λ³΄κ΄€", "μ •λ³΄λ„μ„κ΄€", "μ •λ³΄μ„Όν„°", "μ •μ›", "μΆ…ν•©λ³µμ§€κ΄€", "μ£Όκ±°λ³µν•©",
    "μ£Όλ―Όμ„Όν„°", "μ£Όμƒλ³µν•©", "μ£Όμ°¨μ¥", "μ£Όνƒ", "μ¤‘μ•™μ—­", "μ¤‘ν•™κµ", "μ§€κµ¬λ€", "μ§€λ°©κ²½μ°°μ²­", "μ§€λ°©λ²•μ›", "μ§€μ‚¬",
    "μ§€μ›μ²­", "μ§€μ ", "μ§€ν•μ² ", "μ°½κ³ ", "μ°½μ—…λ³΄μ΅μ„Όν„°", "μ°½μ—…μ§€μ›μ„Όν„°", "μ²λ¬Έλ€", "μ²­μ†λ…„λ¬Έν™”μμ§‘",
    "μ²­μ†λ…„μ„Όν„°", "μ²­μ†λ…„μλ ¨κ΄€", "μ²΄μ΅κ΄€", "μ²΄ν—κ΄€", "μ²΄ν—μ¥", "μ΄λ“±ν•™κµ", "μ¶μ…κµ¬", "μ»¨λ²¤μ…μ„Όν„°", "μ½λ„",
    "νƒ€μ›", "ν„°λ―Έλ„", "νμ¶μ†", "νμ…", "νΈμμ ", "ν”λΌμ", "ν•μ°μ¤", "ν•™κµ", "ν•™μƒνκ΄€", "ν•™μ›", "ν•΄μ–‘κ΄€",
    "ν„λ€λ―Έμ κ΄€", "νΈμ¤ν…”", "νΈν…”", "ν™μΉ", "ν™μΉμ„Όν„°", "νκ΄€", "κ³Όν•™κ΄€", "κ΄‘μ¥",
    "κ³µν•­", "μ§€ν•μ² ", "νΈμ„ ", "μ •λ¥μ¥", "λ²„μ¤", "μ¤ν€μ–΄", "νƒ€μ΄", "λ¬Έν™”", "μ „μ² ", "μ…κµ¬", "μ •λ¬Έ", "ν›„λ¬Έ", "μ¤‘λ¬Έ", "μ¶κµ¬",
    "κ³µκ³µ", "κ³µμ©", "κΈ°κ΄€", "ν‘ν", "λ‹¨μ²΄", "μΊ νΌμ¤", "λ³Έλ¶€", "ν•™μ‚¬", "μƒν™κ΄€", "λ„μ„κ΄€", "μ—°κµ¬μ‹¤", "κ°•μλ™",
    "μ‚¬λ‹Ή", "μ„μ›", "μ‚¬μ°°", "μ„±λ‹Ή", "μ„±μ§€", "μ μ ", "μ‚¬μ μ§€", "λ¬Έν™”μ¬", "νƒ‘", "λ¶μƒ",
    "ν•­", "λ¶€λ‘", "μ¶μ…λ¬Έ", "λ°©λ©΄", "μ „μ² μ—­", "μ—­μ„Έκ¶",
    "λ¬Έν™”λ§μ„", "λ²½ν™”λ§μ„", "λλ‹΄κΈΈ", "κ³¨λ©κΈΈ", "νλ‘", "λ£¨νΈ"
     ]
        result = search_places(x, y, radius, keywords)
        if result:
            df = pd.DataFrame(result)
            now = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"μ¥μ†_λ°κ²½1km_ν‚¤μ›λ“κ²°κ³Ό_{now}.xlsx"
            df.to_excel(filename, index=False)
            st.success(f"β… μ €μ¥ μ™„λ£: {filename} (μ΄ {len(result)}κ°)")
            st.dataframe(df)
        else:
            st.warning("β οΈ κ²°κ³Όκ°€ μ—†μµλ‹λ‹¤.")
